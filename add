#!/bin/bash
[[ -z "$INFO_LEVEL" ]] && source ./submodules/bootstrap/logging
set -euo pipefail ; IFS=$'\n\t'

#-----------
# Configurations
#-----------

DEPLOYKEYS_USER=${DEPLOYKEYS_NAME-root}
DEPLOYKEYS_HOSTNAME=${DEPLOYKEYS_URL-github}
DEPLOYKEYS_HOSTURL=${DEPLOYKEYS_URL-github.com}

#-----------
# Configurations
#-----------

if [[ "`which getent 2> /dev/null`" != "" ]]; then
  debug "  -- Using getent to find home directory of $DEPLOYKEYS_USER"
  USER_HOME="$(getent passwd $DEPLOYKEYS_USER | awk -F ':' '{print $6}')"
elif [[ "$DEPLOYKEYS_USER" == root  ]]; then
  debug "  -- Assuming /root home directory for $DEPLOYKEYS_USER"
  USER_HOME=/root
elif [[ -e "/home/$DEPLOYKEYS_USER" ]]; then
  debug "  -- Assuming /home/$DEPLOYKEYS_USER home directory for $DEPLOYKEYS_USER"
  USER_HOME=/home/$DEPLOYKEYS_USER
elif [[ "$DEPLOYKEYS_USER" == "$USER" ]]; then
  debug "  -- Using \$HOME as the home directory current user $USER"
  USER_HOME=$HOME
else
  error "Unable to determine the home directory of $DEPLOYKEYS_USER"
  exit 1
fi

debug "  -- Adding $DEPLOYKEYS_HOSTNAME to ${USER_HOME}/.ssh/known_hosts"
ssh-keyscan -H $DEPLOYKEYS_HOSTURL 2> /dev/null >> ${USER_HOME}/.ssh/known_hosts
